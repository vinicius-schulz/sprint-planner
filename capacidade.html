<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Calculadora de Capacidade Scrum</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .section-title {
      margin-top: 1rem;
    }
  </style>
</head>

<body>
  <div class="container my-4">
    <h1 class="mb-4">Calculadora de Capacidade Scrum</h1>

    <!-- Informações da Sprint -->
    <div class="card mb-3">
      <div class="card-header">Informações da Sprint</div>
      <div class="card-body">
        <div class="mb-3">
          <label for="sprintTitle" class="form-label">Título da Sprint</label>
          <input type="text" id="sprintTitle" class="form-control" placeholder="Digite o título da sprint">
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="sprintStartDate" class="form-label">Data de Início</label>
            <input type="date" id="sprintStartDate" class="form-control">
          </div>
          <div class="col-md-6">
            <label for="sprintEndDate" class="form-label">Data de Fim</label>
            <input type="date" id="sprintEndDate" class="form-control">
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="totalHorasSprint" class="form-label">Horas Úteis Totais da Sprint</label>
            <input type="text" id="totalHorasSprint" class="form-control" value="0" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label">Capacidade Total (SP)</label>
            <input type="text" id="totalCapacityDisplay" class="form-control" value="0" readonly>
          </div>
        </div>
        <small class="text-muted d-block mb-3">
          Horas úteis calculadas com base na data de início, data de fim, dias não úteis, eventos da sprint e horas diárias.
        </small>
        <!-- Dias Não Úteis -->
        <div class="mb-3">
          <h5>Dias Não Úteis</h5>
          <p class="text-muted">
            Os finais de semana serão adicionados automaticamente. Remova ou adicione outros dias não úteis.
          </p>
          <div class="input-group mb-3">
            <input type="date" id="nonWorkingDayInput" class="form-control">
            <button id="addNonWorkingDay" class="btn btn-primary">Adicionar Dia Não Útil</button>
          </div>
          <ul class="list-group" id="nonWorkingDaysList">
            <!-- Lista de dias não úteis -->
          </ul>
        </div>
        <!-- Eventos da Sprint -->
        <div class="mb-3">
          <h5>Eventos da Sprint</h5>
          <p class="text-muted">Informe os eventos relevantes ocorridos na sprint.</p>
          <table class="table table-bordered" id="eventosTable">
            <thead>
              <tr>
                <th>Tipo de Evento</th>
                <th>Descrição</th>
                <th>Data de Ocorrência</th>
                <th>Tempo Gasto (min)</th>
                <th>Recorrente</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              <!-- Linhas de eventos serão inseridas dinamicamente -->
            </tbody>
          </table>
          <button id="addEvento" class="btn btn-primary btn-sm">Adicionar Evento</button>
        </div>
      </div>
    </div>

    <!-- Abas: Time e Configurações Globais -->
    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="dev-tab" data-bs-toggle="tab" data-bs-target="#dev" type="button" role="tab"
          aria-controls="dev" aria-selected="true">Time</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button" role="tab"
          aria-controls="config" aria-selected="false">Configurações Globais</button>
      </li>
    </ul>
    <div class="tab-content" id="myTabContent">
      <!-- Aba Time -->
      <div class="tab-pane fade show active" id="dev" role="tabpanel" aria-labelledby="dev-tab">
        <div class="card mt-3">
          <div class="card-body">
            <div id="developersContainer">
              <!-- Cards de membro serão inseridos aqui -->
            </div>
            <button id="addDeveloper" class="btn btn-primary">Adicionar Membro</button>
          </div>
        </div>
      </div>
      <!-- Aba Configurações Globais -->
      <div class="tab-pane fade" id="config" role="tabpanel" aria-labelledby="config-tab">
        <div class="card mt-3">
          <div class="card-body">
            <div class="mb-3">
              <label for="dailyWorkHours" class="form-label">Horas Diárias para Trabalho</label>
              <input type="number" id="dailyWorkHours" class="form-control" value="8" min="0">
            </div>
            <!-- Classificações de Desenvolvedor -->
            <h5 class="section-title">Classificações de Desenvolvedor</h5>
            <table class="table table-bordered" id="classificacaoTable">
              <thead>
                <tr>
                  <th>Classificação</th>
                  <th>Taxa (%)</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <button id="addClassificacao" class="btn btn-primary btn-sm mb-3">Adicionar Classificação</button>
            <!-- Níveis de Maturidade -->
            <h5 class="section-title">Maturidade no Projeto</h5>
            <table class="table table-bordered" id="maturidadeTable">
              <thead>
                <tr>
                  <th>Maturidade</th>
                  <th>Taxa (%)</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <button id="addMaturidade" class="btn btn-primary btn-sm mb-3">Adicionar Nível de Maturidade</button>
            <!-- Relação Story Points / Horas -->
            <h5 class="section-title">Relação Story Points / Horas</h5>
            <table class="table table-bordered" id="spHorasTable">
              <thead>
                <tr>
                  <th>Story Points</th>
                  <th>Horas</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <button id="addSPHoras" class="btn btn-primary btn-sm mb-3">Adicionar Relação</button>
            <!-- Tipos de Membro -->
            <h5 class="section-title">Tipos de Membro</h5>
            <table class="table table-bordered" id="tipoTable">
              <thead>
                <tr>
                  <th>Tipo</th>
                  <th>Considerar na Capacidade</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <button id="addTipo" class="btn btn-primary btn-sm">Adicionar Tipo</button>
          </div>
        </div>
      </div>
    </div>

    <!-- A lista de tarefas permanece -->
    <div class="card mb-3">
      <div class="card-header">Lista de Tarefas</div>
      <div class="card-body">
        <table class="table table-bordered" id="tasksTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nome da Tarefa</th>
              <th>Recurso</th>
              <th>Story Points</th>
              <th>Dependências</th>
              <th>Data Inicial</th>
              <th>Data Final</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            <!-- Linhas de tarefas serão inseridas dinamicamente -->
          </tbody>
        </table>
        <button id="addTask" class="btn btn-primary btn-sm">Adicionar Tarefa</button>
        <button id="calculateTaskDatesBtn" class="btn btn-info btn-sm ms-2">Calcular Datas</button>
      </div>
    </div>
  </div>

  <!-- Área de Exportação/Importação e exibição da versão -->
  <div class="container my-4">
    <button id="exportBtn" class="btn btn-secondary">Exportar Dados</button>
    <button id="importBtn" class="btn btn-secondary">Importar Dados</button>
    <input type="file" id="importFileInput" style="display: none;" accept="application/json" />
    <div class="mt-2">
      <small>Versão: <span id="appVersionDisplay"></span></small>
    </div>
  </div>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /*********************** Funcionalidades Básicas ************************/
    let nonWorkingDays = [];

    function renderNonWorkingDaysList() {
      const list = document.getElementById('nonWorkingDaysList');
      list.innerHTML = '';
      nonWorkingDays.sort();
      nonWorkingDays.forEach(date => {
        const li = document.createElement('li');
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.textContent = date;
        const btn = document.createElement('button');
        btn.className = "btn btn-danger btn-sm";
        btn.textContent = "Remover";
        btn.addEventListener('click', () => {
          nonWorkingDays = nonWorkingDays.filter(d => d !== date);
          renderNonWorkingDaysList();
          updateSprintEffectiveHours();
        });
        li.appendChild(btn);
        list.appendChild(li);
      });
      updateSprintEffectiveHours();
    }

    function updateNonWorkingDaysFromDates() {
      const startDateStr = document.getElementById('sprintStartDate').value;
      const endDateStr = document.getElementById('sprintEndDate').value;
      if (!startDateStr || !endDateStr) return;
      const [startYear, startMonth, startDay] = startDateStr.split("-");
      const startDate = new Date(startYear, startMonth - 1, startDay);
      const [endYear, endMonth, endDay] = endDateStr.split("-");
      const endDate = new Date(endYear, endMonth - 1, endDay);
      if (startDate > endDate) return;
      const autoWeekendDays = [];
      let currentDate = new Date(startDate);
      while (currentDate <= endDate) {
        const dayOfWeek = currentDate.getDay();
        if (dayOfWeek === 0 || dayOfWeek === 6) {
          autoWeekendDays.push(currentDate.toISOString().split('T')[0]);
        }
        currentDate.setDate(currentDate.getDate() + 1);
      }
      nonWorkingDays = autoWeekendDays;
      renderNonWorkingDaysList();
      updateSprintEffectiveHours();
    }

    document.getElementById('sprintStartDate').addEventListener('change', updateNonWorkingDaysFromDates);
    document.getElementById('sprintEndDate').addEventListener('change', updateNonWorkingDaysFromDates);
    document.getElementById('addNonWorkingDay').addEventListener('click', () => {
      const input = document.getElementById('nonWorkingDayInput');
      const date = input.value;
      if (date && !nonWorkingDays.includes(date)) {
        nonWorkingDays.push(date);
        renderNonWorkingDaysList();
        input.value = '';
      }
    });

    function addRowToTable(tableId, defaultValues) {
      const tbody = document.querySelector("#" + tableId + " tbody");
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" class="form-control campo1" value="${defaultValues[0] || ''}"></td>
        <td><input type="number" class="form-control campo2" value="${defaultValues[1] || ''}" min="0"></td>
        <td><button type="button" class="btn btn-danger btn-sm remove-config">Remover</button></td>
      `;
      tbody.appendChild(tr);
      tr.querySelector('.remove-config').addEventListener('click', function () {
        tr.remove();
        updateDeveloperDropdowns();
      });
      updateDeveloperDropdowns();
    }

    function updateDeveloperDropdowns() {
      let classificacoes = [];
      document.querySelectorAll("#classificacaoTable tbody tr").forEach(tr => {
        const nome = tr.querySelector('.campo1').value;
        const taxa = tr.querySelector('.campo2').value;
        if (nome.trim() !== "" && taxa.trim() !== "") {
          classificacoes.push({ name: nome, rate: taxa });
        }
      });
      let maturidades = [];
      document.querySelectorAll("#maturidadeTable tbody tr").forEach(tr => {
        const nivel = tr.querySelector('.campo1').value;
        const taxa = tr.querySelector('.campo2').value;
        if (nivel.trim() !== "" && taxa.trim() !== "") {
          maturidades.push({ name: nivel, rate: taxa });
        }
      });
      document.querySelectorAll('.dev-classificacao').forEach(select => {
        const currentValue = select.value;
        select.innerHTML = "";
        classificacoes.forEach(item => {
          const option = document.createElement('option');
          option.value = item.rate;
          option.textContent = item.name + " (" + item.rate + "%)";
          select.appendChild(option);
        });
        if (currentValue && classificacoes.some(i => i.rate === currentValue)) {
          select.value = currentValue;
        }
      });
      document.querySelectorAll('.dev-maturidade').forEach(select => {
        const currentValue = select.value;
        select.innerHTML = "";
        maturidades.forEach(item => {
          const option = document.createElement('option');
          option.value = item.rate;
          option.textContent = item.name + " (" + item.rate + "%)";
          select.appendChild(option);
        });
        if (currentValue && maturidades.some(i => i.rate === currentValue)) {
          select.value = currentValue;
        }
      });
    }

    function addTipoRow(defaultValues) {
      const tbody = document.querySelector("#tipoTable tbody");
      const tr = document.createElement('tr');
      const typeName = defaultValues[0] || '';
      const considerFlag = (defaultValues[1] !== undefined) ? defaultValues[1] : true;
      tr.innerHTML = `
        <td><input type="text" class="form-control tipo-name" value="${typeName}"></td>
        <td class="text-center"><input type="checkbox" class="form-check-input tipo-consider" ${considerFlag ? 'checked' : ''}></td>
        <td><button type="button" class="btn btn-danger btn-sm remove-tipo">Remover</button></td>
      `;
      tbody.appendChild(tr);
      tr.querySelector('.remove-tipo').addEventListener('click', function () {
        tr.remove();
        updateTipoDropdowns();
      });
      updateTipoDropdowns();
    }

    function updateTipoDropdowns() {
      const tipos = [];
      document.querySelectorAll("#tipoTable tbody tr").forEach(tr => {
        const nome = tr.querySelector('.tipo-name').value;
        const consider = tr.querySelector('.tipo-consider').checked;
        if (nome.trim() !== "") {
          tipos.push({ name: nome, consider: consider });
        }
      });
      document.querySelectorAll('.dev-tipo').forEach(select => {
        const currentValue = select.value;
        select.innerHTML = "";
        tipos.forEach(item => {
          const option = document.createElement('option');
          option.value = item.name;
          option.textContent = item.name + (item.consider ? " (Contabilizar na Capacidade)" : " (Não Contabilizar na Capacidade)");
          select.appendChild(option);
        });
        if (currentValue && tipos.some(i => i.name === currentValue)) {
          select.value = currentValue;
        }
      });
    }

    function getTipoMapping() {
      const mapping = {};
      document.querySelectorAll("#tipoTable tbody tr").forEach(tr => {
        const nome = tr.querySelector('.tipo-name').value;
        const consider = tr.querySelector('.tipo-consider').checked;
        if (nome.trim() !== "") {
          mapping[nome] = consider;
        }
      });
      return mapping;
    }

    function addEventRow(defaultValues) {
      const tbody = document.querySelector("#eventosTable tbody");
      const tr = document.createElement('tr');
      const tipoDefault = defaultValues && defaultValues[0] ? defaultValues[0] : "Planning";
      const descricaoDefault = defaultValues && defaultValues[1] ? defaultValues[1] : "";
      const dataDefault = defaultValues && defaultValues[2] ? defaultValues[2] : "";
      const tempoDefault = defaultValues && defaultValues[3] ? defaultValues[3] : "";
      const recorrenteDefault = defaultValues && defaultValues[4] ? "checked" : "";
      tr.innerHTML = `
        <td>
          <select class="form-select event-type">
            <option value="Planning" ${tipoDefault === "Planning" ? "selected" : ""}>Planning</option>
            <option value="Refinamento" ${tipoDefault === "Refinamento" ? "selected" : ""}>Refinamento</option>
            <option value="Review" ${tipoDefault === "Review" ? "selected" : ""}>Review</option>
            <option value="Retrospectiva" ${tipoDefault === "Retrospectiva" ? "selected" : ""}>Retrospectiva</option>
            <option value="Daily" ${tipoDefault === "Daily" ? "selected" : ""}>Daily</option>
            <option value="Outros" ${tipoDefault === "Outros" ? "selected" : ""}>Outros</option>
          </select>
        </td>
        <td><input type="text" class="form-control event-description" value="${descricaoDefault}"></td>
        <td><input type="date" class="form-control event-date" value="${dataDefault}"></td>
        <td><input type="number" class="form-control event-duration" value="${tempoDefault}" min="0"></td>
        <td class="text-center"><input type="checkbox" class="form-check-input event-recurring" ${recorrenteDefault}></td>
        <td><button type="button" class="btn btn-danger btn-sm remove-event">Remover</button></td>
      `;
      tbody.appendChild(tr);
      tr.querySelectorAll('.event-date, .event-duration, .event-recurring').forEach(input => {
        input.addEventListener('change', () => {
          updateSprintEffectiveHours();
        });
      });
      tr.querySelector('.remove-event').addEventListener('click', function () {
        tr.remove();
        updateSprintEffectiveHours();
      });
    }

    document.getElementById('addEvento').addEventListener('click', function () {
      addEventRow();
    });

    function calculateTotalWorkingHours() {
      const startDateStr = document.getElementById('sprintStartDate').value;
      const endDateStr = document.getElementById('sprintEndDate').value;
      if (!startDateStr || !endDateStr) return 0;
      const [startYear, startMonth, startDay] = startDateStr.split("-");
      const startDate = new Date(startYear, startMonth - 1, startDay);
      const [endYear, endMonth, endDay] = endDateStr.split("-");
      const endDate = new Date(endYear, endMonth - 1, endDay);
      if (startDate > endDate) return 0;
      let workingDays = 0;
      let currentDate = new Date(startDate);
      while (currentDate <= endDate) {
        const dateStr = currentDate.toISOString().split('T')[0];
        if (!nonWorkingDays.includes(dateStr)) {
          workingDays++;
        }
        currentDate.setDate(currentDate.getDate() + 1);
      }
      const dailyHours = parseFloat(document.getElementById('dailyWorkHours').value) || 8;
      let totalAvailableHours = workingDays * dailyHours;
      const eventRows = document.querySelectorAll("#eventosTable tbody tr");
      let totalEventHours = 0;
      eventRows.forEach(tr => {
        const eventDate = tr.querySelector('.event-date').value;
        const eventDurationMinutes = parseFloat(tr.querySelector('.event-duration').value) || 0;
        const isRecurring = tr.querySelector('.event-recurring').checked;
        if (isRecurring) {
          totalEventHours += (eventDurationMinutes / 60) * workingDays;
        } else {
          if (eventDate) {
            const eventDateObj = new Date(eventDate);
            if (eventDateObj >= startDate && eventDateObj <= endDate && !nonWorkingDays.includes(eventDate)) {
              totalEventHours += (eventDurationMinutes / 60);
            }
          }
        }
      });
      const effectiveHours = totalAvailableHours - totalEventHours;
      return effectiveHours > 0 ? effectiveHours : 0;
    }

    // Atualiza as horas úteis e chama o cálculo da capacidade
    function updateSprintEffectiveHours() {
      const effectiveHours = calculateTotalWorkingHours();
      document.getElementById('totalHorasSprint').value = effectiveHours.toFixed(2).replace('.', ',');
      updateCapacity();
    }

    document.getElementById('dailyWorkHours').addEventListener('change', updateSprintEffectiveHours);

    /***************** Função para calcular a capacidade de cada membro *****************/
    // Função definida para converter horas disponíveis e mapeamento de SP para capacidade (SP)
    function calcularCapacidadePorDev(availableHours, spMapping) {
      let capacity = 0;
      let horaAtual = availableHours;
      while (horaAtual > 0) {
        let repetiu = true;
        for (let i = 0; i < spMapping.length; i++) {
          const requiredHours = parseFloat(spMapping[i].horas);
          const spValue = parseFloat(spMapping[i].sp);
          if (requiredHours > 0 && requiredHours <= horaAtual) {
            horaAtual -= requiredHours;
            capacity += spValue;
            repetiu = false;
            break;
          }
        }
        if (repetiu) {
          for (let j = spMapping.length - 1; j >= 0; j--) {
            const requiredHours = parseFloat(spMapping[j].horas);
            if (requiredHours > 0) {
              if (spMapping.length > 1) {
                capacity += parseFloat(spMapping[spMapping.length - 2].sp);
              } else {
                capacity += parseFloat(spMapping[0].sp);
              }
              horaAtual = 0;
              break;
            }
          }
        }
      }
      return capacity;
    }

    // Atualiza a capacidade dos membros e da sprint com formatação
    function updateCapacity() {
      const sprintEffectiveHours = calculateTotalWorkingHours();
      document.getElementById('totalHorasSprint').value = sprintEffectiveHours.toFixed(2).replace('.', ',');
      
      let spMapping = [];
      document.querySelectorAll("#spHorasTable tbody tr").forEach(tr => {
        const sp = tr.querySelector('.campo1').value;
        const horas = tr.querySelector('.campo2').value;
        if (sp.trim() !== "" && horas.trim() !== "") {
          spMapping.push({ sp: sp, horas: horas });
        }
      });
      let totalTeamCapacity = 0;
      const tipoMapping = getTipoMapping();
      document.querySelectorAll('#developersContainer .card').forEach(card => {
        const disponibilidade = parseFloat(card.querySelector('.dev-disponibilidade').value) || 100;
        const classificacaoRate = parseFloat(card.querySelector('.dev-classificacao').value) || 100;
        const maturidadeRate = parseFloat(card.querySelector('.dev-maturidade').value) || 100;
        const devEffectiveHours = sprintEffectiveHours * (disponibilidade / 100) * (classificacaoRate / 100) * (maturidadeRate / 100);
        let devCapacity = calcularCapacidadePorDev(devEffectiveHours, spMapping);
        const tipoSelect = card.querySelector('.dev-tipo');
        const selectedTipo = tipoSelect ? tipoSelect.value : "";
        if (tipoMapping[selectedTipo] === false) {
          devCapacity = 0;
        }
        totalTeamCapacity += devCapacity;
        card.querySelector('.dev-capacidade').value = devCapacity.toFixed(2).replace('.', ',');
      });
      document.getElementById('totalCapacityDisplay').value = totalTeamCapacity.toFixed(2).replace('.', ',');
    }

    // Atualiza capacidade ao alterar campos específicos
    document.addEventListener("input", function(e) {
      if (
        e.target.classList.contains("dev-disponibilidade") ||
        e.target.classList.contains("dev-classificacao") ||
        e.target.classList.contains("dev-maturidade") ||
        e.target.classList.contains("campo1") ||
        e.target.classList.contains("campo2")
      ) {
        updateCapacity();
      }
    });

    /***************** Seção Tarefas *****************/
    function updateTaskResourceDropdowns() {
      const devNames = [];
      document.querySelectorAll("#developersContainer .dev-name").forEach(input => {
        const name = input.value.trim();
        if (name !== "") {
          devNames.push(name);
        }
      });
      document.querySelectorAll("#tasksTable tbody .task-resource").forEach(select => {
        const currentValue = select.value;
        select.innerHTML = `<option value="">Selecione...</option>`;
        devNames.forEach(name => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          select.appendChild(option);
        });
        if (currentValue && devNames.includes(currentValue)) {
          select.value = currentValue;
        }
      });
    }

    function updateTaskSPOptions() {
      const spOptions = [];
      document.querySelectorAll("#spHorasTable tbody tr").forEach(tr => {
        const spVal = tr.querySelector(".campo1").value.trim();
        if (spVal !== "" && !spOptions.includes(spVal)) {
          spOptions.push(spVal);
        }
      });
      document.querySelectorAll("#tasksTable tbody .task-sp").forEach(select => {
        const currentValue = select.value;
        select.innerHTML = `<option value="">Selecione...</option>`;
        spOptions.forEach(sp => {
          const option = document.createElement("option");
          option.value = sp;
          option.textContent = sp;
          select.appendChild(option);
        });
        if (currentValue && spOptions.includes(currentValue)) {
          select.value = currentValue;
        }
      });
    }

    function addTaskRow() {
      const tbody = document.querySelector("#tasksTable tbody");
      const rowCount = tbody.querySelectorAll("tr").length;
      const defaultId = rowCount + 1;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="number" class="form-control task-id" value="${defaultId}" /></td>
        <td><input type="text" class="form-control task-name" placeholder="Nome da Tarefa" /></td>
        <td>
          <select class="form-select task-resource">
            <option value="">Selecione...</option>
          </select>
        </td>
        <td>
          <select class="form-select task-sp">
            <option value="">Selecione...</option>
          </select>
        </td>
        <td><input type="text" class="form-control task-dependencies" placeholder="IDs separados por vírgula" /></td>
        <td><input type="date" class="form-control task-start-date" /></td>
        <td><input type="date" class="form-control task-end-date" /></td>
        <td><button type="button" class="btn btn-danger btn-sm remove-task">Remover</button></td>
      `;
      tbody.appendChild(tr);
      const idInput = tr.querySelector(".task-id");
      idInput.addEventListener("change", validateTaskIDs);
      const dependenciesInput = tr.querySelector(".task-dependencies");
      dependenciesInput.addEventListener("change", function() {
        validateTaskDependencies(tr);
      });
      tr.querySelector(".remove-task").addEventListener("click", function() {
        const removedId = tr.querySelector(".task-id").value;
        tr.remove();
        removeDependencyFromTasks(removedId);
      });
      updateTaskResourceDropdowns();
      updateTaskSPOptions();
    }

    function getTaskIDs() {
      const ids = [];
      document.querySelectorAll("#tasksTable tbody .task-id").forEach(input => {
        const val = input.value.trim();
        if(val !== "") {
          ids.push(val);
        }
      });
      return ids;
    }

    function validateTaskIDs() {
      const allIds = getTaskIDs();
      const idInputs = document.querySelectorAll("#tasksTable tbody .task-id");
      idInputs.forEach(input => {
        const currentVal = input.value.trim();
        if (currentVal === "") return;
        const occurrences = allIds.filter(id => id === currentVal).length;
        if (occurrences > 1) {
          alert("ID de tarefa duplicado: " + currentVal + ". Cada tarefa deve ter um ID único.");
          input.value = "";
        }
      });
    }

    function validateTaskDependencies(row) {
      const idInput = row.querySelector(".task-id");
      const taskId = idInput.value.trim();
      const depInput = row.querySelector(".task-dependencies");
      let deps = depInput.value.split(",").map(d => d.trim()).filter(d => d !== "");
      const validIds = getTaskIDs();
      const filteredDeps = deps.filter(dep => {
        if(dep === taskId) {
          alert("Uma tarefa não pode depender dela mesma: " + dep);
          return false;
        }
        if(!validIds.includes(dep)) {
          alert("Dependência inválida: " + dep + ". Essa tarefa não existe.");
          return false;
        }
        return true;
      });
      depInput.value = filteredDeps.join(", ");
    }

    function removeDependencyFromTasks(removedId) {
      document.querySelectorAll("#tasksTable tbody .task-dependencies").forEach(depInput => {
        let deps = depInput.value.split(",").map(d => d.trim()).filter(d => d !== "");
        if (deps.includes(removedId)) {
          deps = deps.filter(d => d !== removedId);
          depInput.value = deps.join(", ");
        }
      });
    }

    document.addEventListener("input", function(e) {
      if(e.target.classList.contains("dev-name")) {
        updateTaskResourceDropdowns();
      }
    });

    document.getElementById("addTask").addEventListener("click", addTaskRow);

    /***************** Cálculo Automático das Datas das Tarefas *****************/
    function formatDate(date) {
      let yyyy = date.getFullYear();
      let mm = String(date.getMonth() + 1).padStart(2, '0');
      let dd = String(date.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function isWorkingDay(date) {
      let dateStr = formatDate(date);
      return !nonWorkingDays.includes(dateStr);
    }

    function getNextWorkingDate(date) {
      let d = new Date(date);
      while (!isWorkingDay(d)) {
         d.setDate(d.getDate() + 1);
      }
      return d;
    }

    function addWorkingDays(date, days) {
      let d = new Date(date);
      while (days > 0) {
         d.setDate(d.getDate() + 1);
         if (isWorkingDay(d)) {
             days--;
         }
      }
      return d;
    }

    function getSPMapping() {
      let mapping = {};
      document.querySelectorAll("#spHorasTable tbody tr").forEach(tr => {
        const spVal = tr.querySelector(".campo1").value.trim();
        const horasVal = tr.querySelector(".campo2").value.trim();
        if (spVal !== "" && horasVal !== "") {
          mapping[spVal] = parseFloat(horasVal);
        }
      });
      return mapping;
    }

    function calculateTaskDates() {
      const sprintStartStr = document.getElementById("sprintStartDate").value;
      if (!sprintStartStr) {
        alert("Informe a data de início da sprint.");
        return;
      }
      const sprintStart = new Date(sprintStartStr);
      const dailyWorkHours = parseFloat(document.getElementById("dailyWorkHours").value) || 8;
      const spMapping = getSPMapping();
      let taskRows = Array.from(document.querySelectorAll("#tasksTable tbody tr"));
      let tasks = taskRows.map(row => {
          const id = parseInt(row.querySelector(".task-id").value.trim());
          const resource = row.querySelector(".task-resource").value.trim();
          const sp = row.querySelector(".task-sp").value.trim();
          const deps = row.querySelector(".task-dependencies").value.split(",").map(d => d.trim()).filter(d => d !== "");
          return { id, resource, sp, deps, row, start: null, end: null };
      });
      tasks.sort((a, b) => a.id - b.id);
      const resourceDates = {};
      tasks.forEach(task => {
        if (!task.resource) {
          task.start = "";
          task.end = "";
          return;
        }
        if (!resourceDates[task.resource]) {
          resourceDates[task.resource] = new Date(sprintStart);
        }
        let candidate = new Date(resourceDates[task.resource]);
        task.deps.forEach(depId => {
          const depTask = tasks.find(t => t.id == depId);
          if (depTask && depTask.end) {
            const depEnd = new Date(depTask.end);
            const nextDay = addWorkingDays(depEnd, 1);
            if (nextDay > candidate) {
              candidate = nextDay;
            }
          }
        });
        candidate = getNextWorkingDate(candidate);
        let durationDays = 1;
        if (task.sp in spMapping) {
          const horasNecessarias = spMapping[task.sp];
          durationDays = Math.ceil(horasNecessarias / dailyWorkHours);
        }
        task.start = candidate;
        const taskEnd = addWorkingDays(candidate, durationDays - 1);
        task.end = taskEnd;
        resourceDates[task.resource] = addWorkingDays(taskEnd, 1);
      });
      tasks.forEach(task => {
        const startInput = task.row.querySelector(".task-start-date");
        const endInput = task.row.querySelector(".task-end-date");
        startInput.value = task.start ? formatDate(task.start) : "";
        endInput.value = task.end ? formatDate(task.end) : "";
      });
    }

    document.getElementById("calculateTaskDatesBtn").addEventListener("click", calculateTaskDates);

    /***************** Funcionalidade de Exportação/Importação *****************/
    const appVersion = "calculadora de capacidade scrum - v1.2.5";
    document.getElementById("appVersionDisplay").innerText = appVersion;

    function exportData() {
      let data = {
        version: appVersion,
        sprint: {
          title: document.getElementById("sprintTitle").value,
          startDate: document.getElementById("sprintStartDate").value,
          endDate: document.getElementById("sprintEndDate").value
        },
        nonWorkingDays: nonWorkingDays,
        events: [],
        teamMembers: [],
        tasks: [],
        globalSettings: {
          dailyWorkHours: document.getElementById("dailyWorkHours").value,
          classificacoes: [],
          maturities: [],
          spMapping: [],
          tipos: []
        }
      };

      document.querySelectorAll("#eventosTable tbody tr").forEach(row => {
        let eventType = row.querySelector(".event-type").value;
        let description = row.querySelector(".event-description").value;
        let date = row.querySelector(".event-date").value;
        let duration = row.querySelector(".event-duration").value;
        let recurring = row.querySelector(".event-recurring").checked;
        data.events.push({ eventType, description, date, duration, recurring });
      });

      document.querySelectorAll("#developersContainer .card").forEach(card => {
        let name = card.querySelector(".dev-name").value;
        let tipo = card.querySelector(".dev-tipo").value;
        let classificacao = card.querySelector(".dev-classificacao").value;
        let maturidade = card.querySelector(".dev-maturidade").value;
        let disponibilidade = card.querySelector(".dev-disponibilidade").value;
        data.teamMembers.push({ name, tipo, classificacao, maturidade, disponibilidade });
      });

      document.querySelectorAll("#tasksTable tbody tr").forEach(row => {
        let id = row.querySelector(".task-id").value;
        let name = row.querySelector(".task-name").value;
        let resource = row.querySelector(".task-resource").value;
        let sp = row.querySelector(".task-sp").value;
        let dependencies = row.querySelector(".task-dependencies").value;
        let startDate = row.querySelector(".task-start-date").value;
        let endDate = row.querySelector(".task-end-date").value;
        data.tasks.push({ id, name, resource, sp, dependencies, startDate, endDate });
      });

      document.querySelectorAll("#classificacaoTable tbody tr").forEach(row => {
        let classification = row.querySelector(".campo1").value;
        let rate = row.querySelector(".campo2").value;
        data.globalSettings.classificacoes.push({ classification, rate });
      });

      document.querySelectorAll("#maturidadeTable tbody tr").forEach(row => {
        let maturity = row.querySelector(".campo1").value;
        let rate = row.querySelector(".campo2").value;
        data.globalSettings.maturities.push({ maturity, rate });
      });

      document.querySelectorAll("#spHorasTable tbody tr").forEach(row => {
        let sp = row.querySelector(".campo1").value;
        let hours = row.querySelector(".campo2").value;
        data.globalSettings.spMapping.push({ sp, hours });
      });

      document.querySelectorAll("#tipoTable tbody tr").forEach(row => {
        let tipo = row.querySelector(".tipo-name").value;
        let consider = row.querySelector(".tipo-consider").checked;
        data.globalSettings.tipos.push({ tipo, consider });
      });

      let jsonStr = JSON.stringify(data, null, 2);
      let fileName = prompt("Digite o nome do arquivo para exportação (ex: dados.json):", "dados.json");
      if (!fileName) return;
      let blob = new Blob([jsonStr], { type: "application/json" });
      let link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = fileName;
      link.click();
    }

    function importDataFromFile(event) {
      let file = event.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = function(e) {
        try {
          let jsonData = JSON.parse(e.target.result);
          importData(jsonData);
        } catch (err) {
          alert("Erro ao importar o arquivo: " + err);
        }
      };
      reader.readAsText(file);
    }

    function importData(data) {
      document.getElementById("sprintTitle").value = data.sprint.title || "";
      document.getElementById("sprintStartDate").value = data.sprint.startDate || "";
      document.getElementById("sprintEndDate").value = data.sprint.endDate || "";
      nonWorkingDays = data.nonWorkingDays || [];
      renderNonWorkingDaysList();

      let eventosTbody = document.querySelector("#eventosTable tbody");
      eventosTbody.innerHTML = "";
      (data.events || []).forEach(eventObj => {
        let tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <select class="form-select event-type">
              <option value="Planning" ${eventObj.eventType === "Planning" ? "selected" : ""}>Planning</option>
              <option value="Refinamento" ${eventObj.eventType === "Refinamento" ? "selected" : ""}>Refinamento</option>
              <option value="Review" ${eventObj.eventType === "Review" ? "selected" : ""}>Review</option>
              <option value="Retrospectiva" ${eventObj.eventType === "Retrospectiva" ? "selected" : ""}>Retrospectiva</option>
              <option value="Daily" ${eventObj.eventType === "Daily" ? "selected" : ""}>Daily</option>
              <option value="Outros" ${eventObj.eventType === "Outros" ? "selected" : ""}>Outros</option>
            </select>
          </td>
          <td><input type="text" class="form-control event-description" value="${eventObj.description}" /></td>
          <td><input type="date" class="form-control event-date" value="${eventObj.date}" /></td>
          <td><input type="number" class="form-control event-duration" value="${eventObj.duration}" min="0" /></td>
          <td class="text-center"><input type="checkbox" class="form-check-input event-recurring" ${eventObj.recurring ? "checked" : ""} /></td>
          <td><button type="button" class="btn btn-danger btn-sm remove-event">Remover</button></td>
        `;
        eventosTbody.appendChild(tr);
        tr.querySelectorAll('.event-date, .event-duration, .event-recurring').forEach(input => {
          input.addEventListener('change', updateSprintEffectiveHours);
        });
        tr.querySelector('.remove-event').addEventListener('click', function () {
          tr.remove();
          updateSprintEffectiveHours();
        });
      });

      let devContainer = document.getElementById("developersContainer");
      devContainer.innerHTML = "";
      (data.teamMembers || []).forEach(member => {
        let card = document.createElement("div");
        card.className = "card mb-3";
        card.innerHTML = `
          <div class="card-header">
            Membro
            <button type="button" class="btn-close float-end remove-developer" aria-label="Remover"></button>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Nome</label>
              <input type="text" class="form-control dev-name" placeholder="Nome do Membro" value="${member.name}" />
            </div>
            <div class="mb-3">
              <label class="form-label">Tipo</label>
              <select class="form-select dev-tipo"></select>
            </div>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Classificação</label>
                <select class="form-select dev-classificacao"></select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Maturidade</label>
                <select class="form-select dev-maturidade"></select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Taxa de Disponibilidade (%)</label>
                <input type="number" class="form-control dev-disponibilidade" value="${member.disponibilidade}" min="0" max="100" />
              </div>
            </div>
            <div class="mt-3">
              <label class="form-label">Capacidade do Membro (SP)</label>
              <input type="text" class="form-control dev-capacidade" value="0" readonly />
            </div>
          </div>
        `;
        devContainer.appendChild(card);
        card.querySelector('.remove-developer').addEventListener('click', function () {
          card.remove();
          updateCapacity();
        });
      });
      updateDeveloperDropdowns();
      updateTipoDropdowns();

      let tasksTbody = document.querySelector("#tasksTable tbody");
      tasksTbody.innerHTML = "";
      (data.tasks || []).forEach(task => {
        let tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input type="number" class="form-control task-id" value="${task.id}" /></td>
          <td><input type="text" class="form-control task-name" placeholder="Nome da Tarefa" value="${task.name}" /></td>
          <td>
            <select class="form-select task-resource">
              <option value="">Selecione...</option>
            </select>
          </td>
          <td>
            <select class="form-select task-sp">
              <option value="">Selecione...</option>
            </select>
          </td>
          <td><input type="text" class="form-control task-dependencies" placeholder="IDs separados por vírgula" value="${task.dependencies}" /></td>
          <td><input type="date" class="form-control task-start-date" value="${task.startDate}" /></td>
          <td><input type="date" class="form-control task-end-date" value="${task.endDate}" /></td>
          <td><button type="button" class="btn btn-danger btn-sm remove-task">Remover</button></td>
        `;
        tasksTbody.appendChild(tr);
        const idInput = tr.querySelector(".task-id");
        idInput.addEventListener("change", validateTaskIDs);
        const dependenciesInput = tr.querySelector(".task-dependencies");
        dependenciesInput.addEventListener("change", function() {
          validateTaskDependencies(tr);
        });
        tr.querySelector(".remove-task").addEventListener("click", function() {
          const removedId = tr.querySelector(".task-id").value;
          tr.remove();
          removeDependencyFromTasks(removedId);
        });
      });

      document.getElementById("dailyWorkHours").value = data.globalSettings.dailyWorkHours || 8;

      let classificacaoTbody = document.querySelector("#classificacaoTable tbody");
      classificacaoTbody.innerHTML = "";
      (data.globalSettings.classificacoes || []).forEach(item => {
        addRowToTable("classificacaoTable", [item.classification, item.rate]);
      });

      let maturidadeTbody = document.querySelector("#maturidadeTable tbody");
      maturidadeTbody.innerHTML = "";
      (data.globalSettings.maturities || []).forEach(item => {
        addRowToTable("maturidadeTable", [item.maturity, item.rate]);
      });

      let spTbody = document.querySelector("#spHorasTable tbody");
      spTbody.innerHTML = "";
      (data.globalSettings.spMapping || []).forEach(item => {
        addRowToTable("spHorasTable", [item.sp, item.hours]);
      });

      let tipoTbody = document.querySelector("#tipoTable tbody");
      tipoTbody.innerHTML = "";
      (data.globalSettings.tipos || []).forEach(item => {
        addTipoRow([item.tipo, item.consider]);
      });

      updateTaskResourceDropdowns();
      updateTaskSPOptions();

      updateSprintEffectiveHours();
    }

    /***************** Eventos de Exportação/Importação *****************/
    document.getElementById("exportBtn").addEventListener("click", exportData);
    document.getElementById("importBtn").addEventListener("click", function() {
      document.getElementById("importFileInput").click();
    });
    document.getElementById("importFileInput").addEventListener("change", importDataFromFile);
  </script>
</body>

</html>
